# PoC Report: 数式OCR→Markdown整形

- **実施日**: 2025-11-23
- **実施者**: t_ryohei
- **対象機能**: OCR から生成された Markdown の数式整形（Pix2Text + `markdown_cleanup`）

## 1. 目的
- YomiToku が崩した数式ブロックを Pix2Text によって LaTeX 化し、Markdown/Word で再利用できるかを検証する。
- 分数や指数を含む問題集 PDF でも 90% 以上の再現性を担保できるか確認する。

## 2. 方法
1. PDF を `ocr_chanked.py` で画像化 → YomiToku で Markdown 化。
2. 同ページ画像を Pix2Text で解析し、ElementType.FORMULA の LaTeX を抽出。
3. `MathRefiner` + `markdown_cleanup` で Markdown 内の式行を Pix2Text の出力に置換。
4. `応用技術者教科書` / `数的処理A` のサンプルページ（確率・円の面積など分数を含む）を目視確認。

## 3. 結果
- 分数 (`\frac`)、桁区切り、`×100` など複合記号の再現率が 60% 前後に留まり、特に `\frac{3}{10}` 等が `\frac{3} {1 0}` のように崩れた。
- Pix2Text 出力が既に `$...$` を含むため、プレーン Markdown との2重ラップを防ぐロジックが必要になった。
- 数式以外の `<img>` タグや URL まで誤置換する副作用が発生し、ルールベースの調整コストが大きい。
- 最終的に **プレーンテキスト（`<br>` と画像リンクのみ）を出力し、数式整形は後工程で行う** 方針へ転換する結論となった。

## 4. 判断
- **実装ステータス**: 数式の自動整形はフェーズ1では「見送り」。プレーンテキスト出力を正式採用。
- **理由**:
  - Pix2Text 単体では分数・表現揺れが多く、定量ゴール（90%再現）を満たせない。
  - ルールベースの正常化に時間がかかり、成果が安定しない。
  - 本質的には「ローカル LLM など高度な整形エンジン」か「人手による整形」のどちらかが必要。

## 5. 次アクション
- `ocr_chanked.py` のデフォルト出力をプレーンテキスト化し、余計な `$$` や疑似数式を残さない。
- 長期タスクとして「ローカル LLM 連携オプション」を検討し、プレーンテキスト＋LLM 整形という2段構成を模索する。
- 要件定義テンプレートに今回の反省を反映し、次回は PoC 計画と成功指標を明文化したうえで着手する。
