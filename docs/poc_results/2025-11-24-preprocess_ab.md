# PoC Report: PDF→Markdown 前処理 A/B 検証

- **実施日**: 2025-11-24
- **実施者**: t_ryohei
- **対象機能**: PDF（数的処理A）からの Markdown 生成における前処理パラメータ（DPI / 二値化 / ノイズ除去）

## 1. 目的
- OCR 精度より前段の「PDF→ページ画像」工程を調整し、Markdown の誤字・レイアウト崩れを抑えられる条件を把握する。
- 現状採用している 150DPI + 単純二値化と、200DPI + 適応二値化 + ノイズ除去を比較し、効果とコストを定量化する。

## 2. Dataset / Metric
- PDF: `result/数的処理A/`（11ページ分、図と表を含む）
- Metric: (a) Markdown 1ページあたりの再修正箇所の個数、(b) 図表リンク欠落数、(c) 1ページあたり平均処理時間（OCR 完了まで）
- 判定方法: `markdown_cleanup` 後の `page_XXXX.md` を確認し、①見出し崩れ ②数値の桁落ち ③図表リンク欠落 を人手でカウント

## 3. 設定
| パターン | DPI | 二値化 | ノイズ除去 | OCR 実行時間 (平均) |
| --- | --- | --- | --- | --- |
| **A** | 150 | Otsu (グレイスケール) | なし | 24.1s / ページ |
| **B** | 200 | Adaptive Threshold (11×11) | OpenCV bilateral (d=9) | 28.7s / ページ |

追加共通条件:
- `ocr_chanked.py --mode lite --chunk-size 5 --rest-seconds 3`
- `--keep-page-images` で元画像を保存。

## 4. 結果
| メトリクス | パターンA | パターンB | メモ |
| --- | --- | --- | --- |
| 1ページあたり再修正箇所 | 8.3 | **4.6** | `1-3` 節見出し・箇条書きのズレが半減。Bは文字縁がシャープ。 |
| 図表リンク欠落数（全11p） | 3 | **0** | Bは `--figure` の画像抽出が安定。Aは細線図が分割されず欠落。 |
| OCR失敗ページ | 0 | 0 | いずれも lite で完走。 |
| 平均処理時間 | **24.1s** | 28.7s | Bは+4.6s。チャンク全体で +23s。 |

## 5. 判断
- **Go**: パターンB（200DPI + adaptive + bilateral）を現行既定に採用する。
- 理由: 修正点が 45% 減少し、図表欠落も解消。処理時間の増分 (+19%) は許容範囲。
- 既存の低スペックPCへの影響は、チャンク毎休止 (`--rest-seconds`) を 5s へ延ばす案で吸収。

## 6. TODO / 次アクション
1. `ingest.py` / `ocr_chanked.py` のデフォルト DPI・前処理をパターンBへ統一し、CLI オプションで A/B を切替できるようにする。
2. `docs/Tasks.md` のフェーズ1タスクに、今回の前処理設定をベースラインとして追記済み。今後は `docs/poc_results/` に継続的にログを追加する運用を続ける。
3. さらなる改善として、傾き補正（Hough-based deskew）と局所コントラスト強調（CLAHE）の PoC を次サイクルで実施する。
